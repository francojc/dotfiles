#!/usr/bin/env bash

# transcribe: Transcribe an audio file using OpenAI's Whisper
# Usage: transcribe [-h|--help] -f FILE_PATH
# Example: transcribe -f "audio.mp3"

set -euo pipefail

# Function to display help message
show_help() {
  cat << EOF
transcribe - Audio transcription using OpenAI Whisper

USAGE:
    transcribe [-h|--help] -f FILE_PATH

DESCRIPTION:
    Transcribes audio files using OpenAI's Whisper-1 model. The script
    processes audio files and saves the transcribed text to a .txt file
    with the same base name as the input file.

DEPENDENCIES:
    - curl: For making API requests
    - jq: For JSON processing
    - pass: For password store access to API keys

ENVIRONMENT:
    Uses pass password store for API key: API/OPENAI_API_KEY

SUPPORTED FORMATS:
    - mp3, mp4, mpeg, mpga, m4a, wav, webm

OPTIONS:
    -f FILE_PATH    Audio file to transcribe (required)
    -h, --help      Show this help message

EXAMPLES:
    transcribe -f recording.mp3
    # Transcribe MP3 file to recording.txt

    transcribe -f podcast.m4a
    # Transcribe M4A file to podcast.txt

    transcribe --help
    # Show this help message

NOTES:
    - Output file is saved as {filename}.txt in the same directory
    - Requires valid API key in pass store at API/OPENAI_API_KEY
    - API usage may incur costs based on OpenAI pricing
    - Transcription quality depends on audio quality and clarity

EOF
  exit 0
}

# Validate dependencies
command -v curl >/dev/null 2>&1 || { echo "Error: curl is required" >&2; exit 1; }
command -v jq >/dev/null 2>&1 || { echo "Error: jq is required" >&2; exit 1; }
command -v pass >/dev/null 2>&1 || { echo "Error: pass is required" >&2; exit 1; }

get_pass() {
    local key_name="$1"
    pass "API/${key_name}" || { 
        echo "Error: API key not found in pass store: API/${key_name}" >&2
        exit 1
    }
}

# Check for --help flag before getopts
if [[ "${1:-}" == "--help" ]]; then
    show_help
    exit 0
fi

# Check API key using pass
OPENAI_API_KEY=$(get_pass OPENAI_API_KEY)

# Parse arguments
while getopts ":hf:" opt; do
  case $opt in
    h) show_help ;;
    f) file_path="$OPTARG" ;;
    \?) echo "Invalid option: -$OPTARG" >&2; exit 1 ;;
    :) echo "Option -$OPTARG requires an argument" >&2; exit 1 ;;
  esac
done

# Check if file path was provided
if [[ -z "${file_path:-}" ]]; then
  echo "Error: File path (-f) is required" >&2
  echo "Use -h for usage information" >&2
  exit 1
fi

# Validate file exists
if [[ ! -f "$file_path" ]]; then
  echo "Error: File not found: $file_path" >&2
  exit 1
fi

# Generate output filename
output_file="${file_path%.*}.txt"

# Call OpenAI API with better output handling
response=$(curl -s --write-out "\n%{http_code}" \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -H "Content-Type: multipart/form-data" \
  -F file="@$file_path" \
  -F model="whisper-1" \
  -F response_format="text" \
  https://api.openai.com/v1/audio/transcriptions)

# Separate HTTP status code and content
http_code=$(echo "$response" | tail -n 1)
content=$(echo "$response" | sed '$d')

# Check for errors
if [[ $http_code -ne 200 ]]; then
  if error_message=$(echo "$content" | jq -r '.error.message' 2>/dev/null); then
    echo "API Error (HTTP $http_code): $error_message" >&2
  else
    echo "API Error (HTTP $http_code): Received non-JSON response" >&2
    echo "Raw response: '$content'" >&2
  fi
  exit 1
fi

# Save successful response (plain text)
echo "$content" > "$output_file"
echo "Transcript saved to: $output_file"
