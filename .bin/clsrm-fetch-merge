#!/usr/bin/env bash
# Fetch and merge student repository changes into instructor's branch

SCRIPT_NAME="clsrm-fetch-merge"; SCRIPT_VERSION="1.0.0"
. "$(dirname "$0")/common"

usage(){ cat <<EOF
Usage: clsrm-fetch-merge STUDENT_USERNAME

Fetch and merge a student's repository changes.

This script:
1. Fetches changes from the student's remote repository
2. Checks out the student's branch
3. Merges the student's main branch
4. Pushes the updated branch to origin

Arguments:
  STUDENT_USERNAME    GitHub username of the student

Options:
  -h, --help         Show this help message
  -v, --verbose      Enable verbose output
  -q, --quiet        Suppress informational output
  --version          Show version information
EOF
}

main(){
  local show_help=0 show_version=0
  local OPTIND=1 opt
  while getopts ":hvq-:" opt; do
    case "$opt" in
      h) show_help=1 ;;
      v) VERBOSE=$((VERBOSE+1)) ;;
      q) QUIET=1 ;;
      -) case "$OPTARG" in
           help) show_help=1 ;;
           version) show_version=1 ;;
           verbose) VERBOSE=$((VERBOSE+1)) ;;
           quiet) QUIET=1 ;;
           *) die "Unknown long option --$OPTARG";;
         esac ;;
      \?) die "Unknown option -$OPTARG" ;;
    esac
  done
  shift $((OPTIND-1)) || true
  [[ $show_help -eq 1 ]] && { usage; exit 0; }
  [[ $show_version -eq 1 ]] && { print_version; exit 0; }

  local student_username="${1:-}"
  [[ -n "$student_username" ]] || die "Please provide the student's GitHub username"

  log_info "Fetching changes from $student_username's repository"
  run git fetch "$student_username"

  log_info "Checking out $student_username branch"
  run git checkout "$student_username"

  log_info "Merging $student_username/main"
  if git merge "$student_username/main"; then
    log_info "Merge successful. Pushing changes..."
    run git push origin "$student_username"
    log_info "Successfully updated and pushed $student_username branch"
  else
    log_error "Merge conflict detected. Please resolve the conflict and commit the changes."
    log_error "After resolving the conflict, you can continue by running:"
    log_error "git push origin $student_username"
    exit 1
  fi
}

main "$@"
