#!/usr/bin/env bash

# Export all pass passwords to a file
# in the format of shell variables 'export VAR_NAME=VALUE'
# Usage: pass-export [--help|-h]
# Result: ~/.variables.env file with all pass passwords exported
# as shell variables
# Requires pass and gpg

show_help() {
    cat << EOF
pass-export - Export pass passwords as shell variables

USAGE:
    pass-export [--help|-h]

DESCRIPTION:
    Exports all passwords from the pass password store to a shell
    environment file. Each password is converted to an environment
    variable using the format 'export VAR_NAME=VALUE'.

    Variable names are derived from the password entry names, with
    special characters replaced by underscores and converted to uppercase.

DEPENDENCIES:
    - pass: Password store manager
    - gpg: GNU Privacy Guard for encryption
    - find: For locating password files

OUTPUT:
    - Creates ~/.variables.env with exported variables
    - File permissions set to 600 (secure)
    - Variables safely escaped for shell use

SECURITY NOTES:
    - Output file contains sensitive password data
    - File is created with restrictive permissions (600)
    - Use with caution and ensure proper file security
    - Consider the security implications of storing passwords in plaintext

EXAMPLES:
    pass-export
    # Export all passwords to ~/.variables.env

    pass-export --help
    # Show this help message

NOTES:
    - PASSWORD_STORE_DIR environment variable is respected if set
    - Default password store location: ~/.password-store
    - Overwrites existing ~/.variables.env file
    - Only the password (first line) of each entry is exported

EOF
}

# Check for help flags
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

# Set the output file path
OUTPUT_FILE="${HOME}/.variables.env"

# Create or truncate the output file
> "$OUTPUT_FILE"

# Function to safely escape variable names and values
escape_var_name() {
    # Replace non-alphanumeric characters with underscores
    echo "$1" | sed -E 's/[^a-zA-Z0-9_]/_/g'
}

escape_value() {
    # Escape special characters for shell
    printf '%q' "$1"
}

# Find all pass entries
pass_entries=$(find "${PASSWORD_STORE_DIR:-$HOME/.password-store}" -name "*.gpg" | sed 's|.*/\.password-store/||; s|\.gpg$||')

# Export each pass entry
while IFS= read -r entry; do
    # Get the password
    password=$(pass "$entry")

    # Extract the last part of the path and convert to uppercase
    var_name=$(escape_var_name "$(basename "$entry" | tr '[:lower:]' '[:upper:]')")

    # Escape the password value
    escaped_password=$(escape_value "$password")

    # Write to the output file
    echo "export ${var_name}=${escaped_password}" >> "$OUTPUT_FILE"
done <<< "$pass_entries"

# Set appropriate permissions
chmod 600 "$OUTPUT_FILE"

echo "Pass passwords exported to $OUTPUT_FILE"
