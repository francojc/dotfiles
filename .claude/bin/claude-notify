#!/bin/bash
# Claude Code notification script with TMUX context capture
# Finds the TMUX pane by walking the process tree since hooks
# don't inherit the $TMUX environment variable

SAVE_PANE=false
MESSAGE=""
TITLE="Claude Code"

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --save-pane)
      SAVE_PANE=true
      shift
      ;;
    *)
      if [ -z "$MESSAGE" ]; then
        MESSAGE="$1"
      else
        TITLE="$1"
      fi
      shift
      ;;
  esac
done

MESSAGE="${MESSAGE:-Claude Code notification}"

# Find TMUX pane by walking process tree
find_tmux_pane() {
  local pid=$$

  # Get all tmux pane PIDs and their coordinates
  local pane_info
  pane_info=$(tmux list-panes -a -F '#{pane_pid} #{session_name}:#{window_index}.#{pane_index}' 2>/dev/null)

  [ -z "$pane_info" ] && return 1

  # Walk up process tree looking for a tmux pane
  while [ "$pid" -gt 1 ]; do
    local match
    match=$(echo "$pane_info" | awk -v pid="$pid" '$1 == pid {print $2}')
    if [ -n "$match" ]; then
      echo "$match"
      return 0
    fi
    # Get parent PID
    pid=$(ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ')
    [ -z "$pid" ] && break
  done

  return 1
}

# Only save pane coordinates if --save-pane flag is set
if [ "$SAVE_PANE" = true ]; then
  TMUX_TARGET=$(find_tmux_pane)
  if [ -n "$TMUX_TARGET" ]; then
    echo "$TMUX_TARGET" > ~/.claude/last-notification
  fi
fi

# Send notification (clicking activates terminal)
terminal-notifier \
  -message "$MESSAGE" \
  -title "$TITLE" \
  -sender com.apple.Terminal \
  -activate com.apple.Terminal \
  -sound default

# Play sound
afplay /System/Library/Sounds/Tink.aiff &
